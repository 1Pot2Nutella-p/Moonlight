@page "/admin/tickets"
@using Moonlight.App.Database.Entities
@using Moonlight.App.Events
@using Moonlight.App.Helpers
@using Moonlight.App.Models.Misc
@using Moonlight.App.Repositories
@using Moonlight.App.Services
@using Moonlight.App.Services.Files
@using Moonlight.App.Services.Tickets

@inject TicketServerService TicketServerService
@inject TicketClientService TicketClientService
@inject SmartTranslateService SmartTranslateService
@inject Repository<SupportTicket> SupportTicket
@inject ResourceService ResourceService
@inject EventSystem Event

@implements IDisposable

<OnlyAdmin>
    <div class="app-container  container-xxl">
        <div class="d-flex flex-column flex-lg-row">
            <div class="d-none d-lg-flex flex-column flex-lg-row-auto w-100 w-lg-275px" data-kt-drawer="true" data-kt-drawer-name="inbox-aside" data-kt-drawer-activate="{default: true, lg: false}" data-kt-drawer-overlay="true" data-kt-drawer-width="225px" data-kt-drawer-direction="start" data-kt-drawer-toggle="#kt_inbox_aside_toggle" style="">
                <div class="card card-flush mb-0" data-kt-sticky="true" data-kt-sticky-name="inbox-aside-sticky" data-kt-sticky-offset="{default: false, xl: '100px'}" data-kt-sticky-width="{lg: '275px'}" data-kt-sticky-left="auto" data-kt-sticky-top="100px" data-kt-sticky-animation="false" data-kt-sticky-zindex="95" style="">
                    <div class="card-body">
                        <div class="menu menu-column menu-rounded menu-state-bg menu-state-title-primary menu-state-icon-primary menu-state-bullet-primary mb-10">
                            
                            @SupportTicketStatus.OnGoing
                            
                            <div class="menu-item mb-3">
                                <span class="menu-link active">
                                    <span class="menu-icon"><i class="ki-duotone ki-sms fs-2 me-3"><span class="path1"></span><span class="path2"></span></i></span>
                                    <span class="menu-title fw-bold"><TL>Unclaimed</TL></span>
                                    <span class="badge badge-light-success">3</span>
                                </span>
                            </div>
                            
                            <div class="menu-item mb-3">
                                <span class="menu-link">
                                    <span class="menu-icon"><i class="ki-duotone ki-abstract-23 fs-2 me-3"><span class="path1"></span><span class="path2"></span></i></span>
                                    <span class="menu-title fw-bold"><TL>Waiting</TL></span>
                                </span>
                            </div>
                            
                            <div class="menu-item mb-3">
                                <span class="menu-link">
                                    <span class="menu-icon"><i class="ki-duotone ki-file fs-2 me-3"><span class="path1"></span><span class="path2"></span></i></span>
                                    <span class="menu-title fw-bold"><TL>AdminNeeded</TL></span>
                                    <span class="badge badge-light-warning">5</span>
                                </span>
                            </div>
                            
                            <div class="menu-item mb-3">
                                
                                <span class="menu-link">
                                    <span class="menu-icon"><i class="ki-duotone ki-send fs-2 me-3"><span class="path1"></span><span class="path2"></span></i></span>
                                    <span class="menu-title fw-bold"><TL>OnGoing</TL></span>
                                </span>
                            </div>
                            
                            <div class="menu-item">
                                <span class="menu-link">
                                    <span class="menu-icon"><i class='bx bxs-comment-detail'></i></span>
                                    <span class="menu-title fw-bold"><TL>All</TL></span>
                                </span>
                            </div>
                        </div>
    
                        <div class="menu menu-column menu-rounded menu-state-bg menu-state-title-primary">
                            <div class="menu-item mb-3">
                                <span class="menu-link">
                                    <span class="menu-icon">
                                        <i class="ki-duotone ki-abstract-8 fs-5 text-danger me-3 lh-0"><span class="path1"></span><span class="path2"></span></i>                            </span>
                                    <span class="menu-title fw-semibold"><TL>Unclaimed</TL></span>
                                    <span class="badge badge-light-danger">6</span>
                                </span>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
        
            <div class="flex-lg-row-fluid ms-lg-7 ms-xl-10">
                <div class="card">
                    <div class="d-flex align-items-center flex-wrap gap-2">
                        <div class="d-flex align-items-center position-relative">
                            <i class="ki-duotone ki-magnifier fs-3 position-absolute ms-4"><span class="path1"></span><span class="path2"></span></i>        <input type="text" data-kt-inbox-listing-filter="search" class="form-control form-control-sm form-control-solid mw-100 min-w-125px min-w-lg-150px min-w-xxl-200px ps-11" placeholder="Search inbox">
                        </div>
                        
                        <a href="#" class="btn btn-sm btn-icon btn-color-primary btn-light btn-active-light-primary d-lg-none" data-bs-toggle="tooltip" data-bs-dismiss="click" data-bs-placement="top" id="kt_inbox_aside_toggle" aria-label="Toggle inbox menu" data-bs-original-title="Toggle inbox menu" data-kt-initialized="1">
                            <i class="ki-duotone ki-burger-menu-2 fs-3 m-0"><span class="path1"></span><span class="path2"></span><span class="path3"></span><span class="path4"></span><span class="path5"></span><span class="path6"></span><span class="path7"></span><span class="path8"></span><span class="path9"></span><span class="path10"></span></i>    </a>
                    </div>
                </div>
            
                <div class="card-body p-0">
                    <div id="kt_inbox_listing_wrapper" class="dataTables_wrapper dt-bootstrap4 no-footer">
                        <div class="table-responsive">
                            <table class="table table-hover table-row-dashed fs-6 gy-5 my-0 dataTable no-footer" id="kt_inbox_listing">
                                <tbody>
                                
                                <LazyLoader Load="Load">
                                    @if (OpenTickets.Any())
                                    {
                                        foreach (var ticket in OpenTickets)
                                        {
                                            <tr>
                                                <td class="ps-9">
                                                    <div class="form-check form-check-sm form-check-custom form-check-solid mt-3">
                                                        <input class="form-check-input" type="checkbox" value="1">
                                                    </div>
                                                </td>
                                                <td class="w-150px w-md-175px">
                                                    <a href=@("/admin/users/view/" + ticket.Owner.Id) class="d-flex align-items-center text-dark">
                                                        <div class="symbol symbol-35px me-3">
                                                            <div class="symbol  symbol-45px symbol-circle ">
                                                                <img alt="Avatar" src="@ResourceService.Avatar(ticket.Owner)">
                                                            </div>
                                                        </div>
                                                        <span class="fw-semibold">@ticket.Owner.FirstName<a>&nbsp;</a>@ticket.Owner.LastName</span>
                                                    </a>
                                                </td>
                                                <td>
                                                    <div class="text-dark gap-1 pt-2">
                                                        <a href="@("/admin/tickets/view/" + ticket.Id)" class="text-dark">
                                                            <div class="fw-semibold text-muted">
                                                                @if (ticket.Messages.LastOrDefault() == null)
                                                                {
                                                                    <TL>No message sent yet</TL>
                                                                }
                                                                else
                                                                {
                                                                    var message = ticket.Messages.LastOrDefault();
                                                                    if (message != null && message.User != null)
                                                                    {
                                                                        @message.User.FirstName
                                                                        <a>&nbsp;</a>
                                                                        @message.User.LastName
                                                                        <a> - </a>
                                                                        @message.Message
                                                                    }
                                                                }
                                                            </div>
                                                        </a>
                                                    </div>


                                                    <div class="badge badge-light-warning">task</div>
                                                    
                                                    
                                                </td>
                                                <td class="w-100px text-end fs-7 pe-9">
                                                    @(Formatter.FormatAgoFromDateTime(ticket.UpdatedAt))
                                                </td>
                                            </tr>
                                        }
                                    }
                                    
                                </LazyLoader>
                                </tbody>
                            </table>
                        </div>
                        <div class="row px-9 pt-3 pb-5">
                            <div class="col-sm-12 col-md-5 d-flex align-items-center justify-content-center justify-content-md-start">
                                <div class="dataTables_length" id="kt_inbox_listing_length">
                                    <label>
                                        <select name="kt_inbox_listing_length" aria-controls="kt_inbox_listing" class="form-select form-select-sm form-select-solid">
                                            <option value="10">10</option>
                                            <option value="25">25</option>
                                            <option value="50">50</option>
                                            <option value="100">100</option>
                                        </select>
                                    </label>
                                </div>
                            </div>
                        
                            <div class="col-sm-12 col-md-7 d-flex align-items-center justify-content-center justify-content-md-end">
                                <div class="dataTables_paginate paging_simple_numbers" id="kt_inbox_listing_paginate">
                                    <ul class="pagination">
                                        <li class="paginate_button page-item previous disabled" id="kt_inbox_listing_previous">
                                            <a href="#" aria-controls="kt_inbox_listing" data-dt-idx="0" tabindex="0" class="page-link">
                                                <i class="previous"></i>
                                            </a>
                                        </li>
                                        <li class="paginate_button page-item active">
                                            <a href="#" aria-controls="kt_inbox_listing" data-dt-idx="1" tabindex="0" class="page-link">1</a>
                                        </li>
                                        <li class="paginate_button page-item ">
                                            <a href="#" aria-controls="kt_inbox_listing" data-dt-idx="2" tabindex="0" class="page-link">2</a>
                                        </li>
                                        <li class="paginate_button page-item next" id="kt_inbox_listing_next">
                                            <a href="#" aria-controls="kt_inbox_listing" data-dt-idx="3" tabindex="0" class="page-link">
                                                <i class="next"></i>
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</OnlyAdmin>

@code
{
    [CascadingParameter]
    public User User { get; set; }
    
    private LazyLoader? LazyLoader;
    private Dictionary<User, SupportChatMessage?> OpenChats = new();
    private List<SupportTicket> OpenTickets = new();
    
    private LazyLoader? TicketLazyLoader;
    
    private async Task Load(LazyLoader arg)
    {
        OpenTickets = await TicketServerService.GetOpenTickets();
    }

    protected override async Task OnInitializedAsync()
    {
        await Event.On<User>("supportChat.new", this, async user =>
        {
            //TODO: Play sound or smth. Add a config option

            await InvokeAsync(StateHasChanged);
        });
    }

    public async void Dispose()
    {
        await Event.Off("supportChat.new", this);
    }
}