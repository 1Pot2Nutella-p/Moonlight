@page "/tickets/view/{Id:int}"
@using Moonlight.App.Database.Entities
@using Moonlight.App.Events
@using Moonlight.App.Services
@using Moonlight.App.Services.Tickets

@inject TicketServerService TicketServerService
@inject TicketClientService TicketClientService
@inject SmartTranslateService SmartTranslateService
@inject EventSystem Event

<LazyLoader @ref="LazyLoader" Load="Load">
    
    
    
    
    
</LazyLoader>

@code
{
    [Parameter] 
    public int Id { get; set; }
    
    [CascadingParameter]
    public User User { get; set; }

    private LazyLoader? LazyLoader;
    private List<SupportTicket> OpenTickets = new();

    protected override async Task OnInitializedAsync()
    {
        await Event.On<User>("SupportTicket.new", this, async user =>
        {
            OpenTickets = await TicketServerService.GetOpenTickets(user);

            await InvokeAsync(StateHasChanged);
        });
    }

    private async Task Load(LazyLoader arg)
    {
        OpenTickets = await TicketServerService.GetOpenTickets(User);
    }

    public async void Dispose()
    {
        await Event.Off("SupportTicket.new", this);
    }
}